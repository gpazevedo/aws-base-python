name: Deploy Lambda - Dev

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'backend/**'
env:
  PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  # Array of services to deploy (only these services will be deployed as Lambda if changed)
  LAMBDAS: ${{ vars.LAMBDAS || '["api"]' }}

jobs:
  # Detect which services changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter-services.outputs.services }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to detect changes

      - name: Detect changed services
        id: filter-services
        run: |
          echo "LAMBDAS configuration: $LAMBDAS"

          # Parse LAMBDAS array
          LAMBDAS_ARRAY=$(echo "$LAMBDAS" | jq -c '.')
          echo "Services to check: $LAMBDAS_ARRAY"

          # Detect changed files
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "")
          else
            # For workflow_dispatch, check against main branch
            CHANGED_FILES=$(git diff --name-only origin/main HEAD || echo "")
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Find which services from LAMBDAS have changes
          CHANGED_SERVICES="[]"

          for service in $(echo "$LAMBDAS_ARRAY" | jq -r '.[]'); do
            echo "Checking service: $service"

            # Check if this service has changes in:
            # - backend/$service/**
            # - backend/Dockerfile.lambda
            # - .github/workflows/**
            if echo "$CHANGED_FILES" | grep -qE "(^backend/$service/)"; then
              echo "  ✓ Service $service has changes"
              CHANGED_SERVICES=$(echo "$CHANGED_SERVICES" | jq -c ". + [\"$service\"]")
            else
              echo "  ✗ Service $service has no changes"
            fi
          done

          echo "Services to deploy: $CHANGED_SERVICES"
          echo "services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT


  deploy:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.services != '[]' }}
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.PROJECT_NAME }}-github-actions-dev
          aws-region: ${{ env.AWS_REGION }}

      - name: Build and push Lambda Docker image
        run: |
          # Use centralized docker-push.sh script for consistent builds
          ./scripts/docker-push.sh dev ${{ matrix.service }} Dockerfile.lambda

      - name: Update Lambda function
        run: |
          # Use the service-environment-latest tag for Lambda deployments
          ECR_REGISTRY="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          IMAGE_URI="${ECR_REGISTRY}/${{ env.PROJECT_NAME }}:${{ matrix.service }}-dev-latest"

          aws lambda update-function-code \
            --function-name ${{ env.PROJECT_NAME }}-dev-${{ matrix.service }} \
            --image-uri "${IMAGE_URI}"
